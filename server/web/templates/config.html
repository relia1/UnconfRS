{% extends "base.html" %}

{% block title %}Tag Management{% endblock %}

{% block head %}
<link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
<style>
* {
    box-sizing: border-box;
}

.tag-management {
    display: flex;
    flex-direction: column;
    align-items: center;
    padding: 2vw;
    margin: 0 auto;
    width: 90vw;
    max-width: 75vw;
}

.page-header {
    background: #e2e8f0;
    padding: 0.5vw;
    border-radius: 1.5vw;
    box-shadow: 0 0.1vw 0.4vw rgba(0, 0, 0, 0.05);
    margin-bottom: 0.5vw;
    margin-top: 0.5vw;
    width: 100%;
    text-align: center;
}

.page-header h1 {
    color: #2c3e50;
    margin: 0;
    font-weight: 600;
    font-size: 2.5vw;
}

.add-tag-form {
    background: #e2e8f0;
    padding-bottom: 0.5vw;
    padding-left: 0.3vw;
    padding-right: 0.3vw;
    padding-top: 0.0vw;
    border-radius: 1.5vw;
    margin-bottom: 0.5vw;
    border: 0.1vw solid #cbd5e0;
    box-shadow: 0 0.1vw 0.4vw rgba(0, 0, 0, 0.05);
    width: 100%;
}

.add-tag-form h2 {
    color: #2c3e50;
    margin-bottom: 1vw;
    font-weight: 600;
    font-size: 1.2vw;
}

.form-group {
    margin-bottom: 1.5vw;
    display: flex;
    align-items: center;
}

.form-group label {
    display: block;
    margin-bottom: 0.0vw;
    font-weight: 500;
    color: #2c3e50;
    font-size: 1.2vw;
    white-space: nowrap;
    flex-shrink: 0;
}

.form-control {
    width: 100%;
    padding: 0.75vw 1vw;
    border: 0.1vw solid #e2e8f0;
    border-radius: 0.75vw;
    font-size: 1.0vw;
    transition: border-color 0.2s, box-shadow 0.2s;
    background-color: white;
}

.form-control:focus {
    outline: none;
    border-color: #4299e1;
    box-shadow: 0 0 0 0.2vw rgba(66, 153, 225, 0.1);
}

.btn {
    border: none;
    border-radius: 0.75vw;
    cursor: pointer;
    font-size: 1.0vw;
    font-weight: 500;
    transition: background-color 0.2s;
    color: white;
    padding: 0.6vw 1.5vw;
    margin-right: 0.5vw;
    white-space: nowrap;
}

.btn-primary {
    background-color: #4299e1;
}

.btn-primary:hover {
    background-color: #3182ce;
}

.btn-danger {
    background-color: #e53e3e;
}

.btn-danger:hover {
    background-color: #c53030;
}

.btn-secondary {
    background-color: #718096;
}

.btn-secondary:hover {
    background-color: #4a5568;
}

.btn-success {
    background-color: #48bb78;
}

.btn-success:hover {
    background-color: #38a169;
}

.tags-section {
    width: 100%;
}

.tags-section h2 {
    color: #2c3e50;
    margin-bottom: 0.5vw;
    margin-top: 0.5vw;
    font-weight: 600;
    font-size: 1.2vw;
}

.tags-table-container {
    background: #e2e8f0;
    padding: 0.75vw;
    border-radius: 1.5vw;
    box-shadow: 0 0.1vw 0.4vw rgba(0, 0, 0, 0.05);
}

.tags-table {
    width: 100%;
    border-collapse: collapse;
    background: white;
    border-radius: 1vw;
    overflow: hidden;
    box-shadow: 0 0.1vw 0.2vw rgba(0, 0, 0, 0.05);
}

.tags-table th,
.tags-table td {
    padding: 0.6vw;
    text-align: left;
    border-bottom: 0.1vw solid #e2e8f0;
}

.tags-table th {
    background-color: #f8fafc;
    font-weight: 600;
    color: #2c3e50;
    font-size: 1.0vw;
}

.tags-table td {
    font-size: 1.0vw;
}

.tag-name {
    font-weight: 500;
    color: #2c3e50;
}

.edit-form {
    display: none;
    margin-top: 1vw;
}

.edit-form.active {
    display: block;
}

.form-inline {
    display: flex;
    align-items: center;
    gap: 1vw;
    flex-wrap: wrap;
}

.alert {
    padding: 1.2vw;
    margin-bottom: 2vw;
    border-radius: 0.75vw;
    font-size: 1.0vw;
    width: 100%;
}

.alert-success {
    background-color: #c6f6d5;
    border: 0.1vw solid #9ae6b4;
    color: #22543d;
}

.alert-error {
    background-color: #fed7d7;
    border: 0.1vw solid #feb2b2;
    color: #742a2a;
}

.empty-state {
    text-align: center;
    padding: 3vw;
    color: #718096;
    background-color: #f8fafc;
    border-radius: 1vw;
    border: 0.1vw solid #e2e8f0;
}

.empty-state h3 {
    color: #4a5568;
    margin-bottom: 1vw;
    font-size: 1.8vw;
}

.empty-state p {
    font-size: 1.0vw;
}

.fas {
    margin-right: 0.5vw;
}

.tag-actions {
    white-space: nowrap;
}

@media screen and (max-width: 768px) {
    .tag-management {
        max-width: 95vw;
        padding: 3vw;
    }

    .page-header h1 {
        font-size: 4vw;
    }

    .add-tag-form h2,
    .tags-section h2 {
        font-size: 3.5vw;
    }

    .form-control,
    .btn,
    .tags-table th,
    .tags-table td,
    .alert,
    .empty-state p {
        font-size: 2.5vw;
    }

    .form-group label {
        font-size: 2.8vw;
    }

    .empty-state h3 {
        font-size: 3.2vw;
    }

    .form-inline {
        flex-direction: column;
        align-items: stretch;
    }

    .form-inline .form-control {
        margin-bottom: 1vw;
    }

    .tag-actions {
        display: flex;
        flex-direction: column;
        gap: 0.5vw;
    }

    .tags-table th,
    .tags-table td {
        padding: 2vw;
    }
}
</style>
{% endblock %}

{% block content %}
<div class="tag-management">
    <div class="page-header">
        <h1><i class="fas fa-tags"></i> Tag Management</h1>
    </div>

    {% if !is_authenticated %}
    <div class="alert alert-error">
        <i class="fas fa-exclamation-triangle"></i> Access Denied: You must be logged in to manage tags.
    </div>
    {% else %}

    <!-- Add New Tag Form -->
    <div class="add-tag-form">
        <h2><i class="fas fa-plus"></i> Add New Tag</h2>
        <form action="/api/v1/tags" method="post" id="addTagForm">
            <div class="form-group">
                <label for="tag_name">Tag Name:</label>
                <input
                    type="text"
                    id="tag_name"
                    name="tag_name"
                    class="form-control"
                    placeholder="Enter tag name..."
                    required
                    maxlength="80"
                >
            </div>
            <button type="submit" class="btn btn-primary">
                <i class="fas fa-plus"></i> Add Tag
            </button>
        </form>
    </div>

    <!-- Tags List -->
    <div class="tags-section">
        <h2><i class="fas fa-list"></i> Existing Tags</h2>

        {% if tags.len() > 0 %}
        <div class="tags-table-container">
            <table class="tags-table">
                <thead>
                    <tr>
                        <th><i class="fas fa-tag"></i> Tag Name</th>
                        <th><i class="fas fa-cogs"></i> Actions</th>
                    </tr>
                </thead>
                <tbody>
                    {% for tag in tags %}
                    <tr id="tag-row-{{ tag.id }}">
                        <td>
                            <span class="tag-name" id="tag-name-{{ tag.id }}">{{ tag.tag_name }}</span>

                            <!-- Inline Edit Form (hidden by default) -->
                            <div class="edit-form" id="edit-form-{{ tag.id }}">
                                <form class="form-inline" onsubmit="updateTag({{ tag.id }}); return false;">
                                    <input
                                        type="text"
                                        id="edit-tag-name-{{ tag.id }}"
                                        value="{{ tag.tag_name }}"
                                        class="form-control"
                                        style="flex: 1; min-width: 200px;"
                                        required
                                        maxlength="100"
                                    >
                                    <button type="submit" class="btn btn-success">
                                        <i class="fas fa-save"></i> Save
                                    </button>
                                    <button type="button" class="btn btn-secondary" onclick="cancelEdit({{ tag.id }})">
                                        <i class="fas fa-times"></i> Cancel
                                    </button>
                                </form>
                            </div>
                        </td>
                        <td class="tag-actions">
                            <button
                                type="button"
                                class="btn btn-secondary"
                                onclick="startEdit({{ tag.id }})"
                                id="edit-btn-{{ tag.id }}"
                            >
                                <i class="fas fa-edit"></i> Edit
                            </button>
                            <button
                                type="button"
                                class="btn btn-danger"
                                onclick="deleteTag({{ tag.id }}, '{{ tag.tag_name }}')"
                            >
                                <i class="fas fa-trash"></i> Delete
                            </button>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        {% else %}
        <div class="tags-table-container">
            <div class="empty-state">
                <h3><i class="fas fa-inbox"></i> No tags found</h3>
                <p>Create your first tag using the form above.</p>
            </div>
        </div>
        {% endif %}
    </div>

    {% endif %}
</div>

<script>
document.getElementById('addTagForm').addEventListener('submit', async function(e) {
    e.preventDefault();

    const tagName = document.getElementById('tag_name').value;

    try {
        const response = await fetch('/api/v1/tags', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({ tag_name: tagName })
        });

        if (response.ok) {
            window.location.reload();
        } else {
            const error = await response.json();
            alert('Error: ' + error.error);
        }
    } catch (error) {
        alert('Error adding tag: ' + error.message);
    }
});

function startEdit(tagId) {
    document.getElementById('tag-name-' + tagId).style.display = 'none';
    document.getElementById('edit-btn-' + tagId).style.display = 'none';

    document.getElementById('edit-form-' + tagId).classList.add('active');

    document.getElementById('edit-tag-name-' + tagId).focus();
}

function cancelEdit(tagId) {
    document.getElementById('tag-name-' + tagId).style.display = 'inline';
    document.getElementById('edit-btn-' + tagId).style.display = 'inline-block';

    document.getElementById('edit-form-' + tagId).classList.remove('active');

    const originalName = document.getElementById('tag-name-' + tagId).textContent;
    document.getElementById('edit-tag-name-' + tagId).value = originalName;
}

async function updateTag(tagId) {
    const newName = document.getElementById('edit-tag-name-' + tagId).value;

    try {
        const response = await fetch('/api/v1/tags/' + tagId, {
            method: 'PUT',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({ tag_name: newName })
        });

        if (response.ok) {
            // Update the displayed name
            document.getElementById('tag-name-' + tagId).textContent = newName;
            cancelEdit(tagId);
        } else {
            const error = await response.json();
            alert('Error: ' + error.error);
        }
    } catch (error) {
        alert('Error updating tag: ' + error.message);
    }
}

async function deleteTag(tagId, tagName) {
    if (!confirm('Are you sure you want to delete the tag "' + tagName + '"?\n\nThis will also remove it from all sessions.')) {
        return;
    }

    try {
        const response = await fetch('/api/v1/tags/' + tagId, {
            method: 'DELETE'
        });

        if (response.ok) {
            document.getElementById('tag-row-' + tagId).remove();

            const tbody = document.querySelector('.tags-table tbody');
            if (tbody.children.length === 0) {
                window.location.reload();
            }
        } else {
            const error = await response.json();
            alert('Error: ' + error.error);
        }
    } catch (error) {
        alert('Error deleting tag: ' + error.message);
    }
}
</script>
{% endblock %}